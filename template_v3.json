{
   "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "storageAccountId":{
         "type":"string",
         "defaultValue":"/subscriptions/24aae708-4612-497c-a91e-7ec5c657f9db/resourceGroups/colony-zjvmogqwzwvk9593/providers/Microsoft.Storage/storageAccounts/colonyzjvmogqwzwvk9593"
      }
   },
   "resources":[
      {
         "properties":{
            "subnets":[
               {
                  "properties":{
                     "addressPrefix":"10.0.0.0/24"
                  },
                  "name":"mng_subnet"
               },
               {
                  "properties":{
                     "addressPrefix":"10.0.1.0/24"
                  },
                  "name":"app_subnet"
               },
               {
                  "properties":{
                     "addressPrefix":"10.0.2.0/24"
                  },
                  "name":"ag_subnet"
               }
            ],
            "addressSpace":{
               "addressPrefixes":[
                  "10.0.0.0/16"
               ]
            }
         },
         "type":"Microsoft.Network/virtualNetworks",
         "location":"[resourceGroup().location]",
         "name":"vnet",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{
            
         },
         "type":"Microsoft.Network/privateDnsZones",
         "location":"global",
         "dependsOn":[
            "vnet"
         ],
         "name":"azure.ticket.com",
         "apiVersion":"2018-09-01"
      },
      {
         "properties":{
            "registrationEnabled":false,
            "virtualNetwork":{
               "id":"[resourceId('Microsoft.Network/virtualNetworks/','vnet')]"
            }
         },
         "type":"Microsoft.Network/privateDnsZones/virtualNetworkLinks",
         "location":"global",
         "dependsOn":[
            "azure.ticket.com"
         ],
         "name":"azure.ticket.com/vnet-link",
         "apiVersion":"2018-09-01"
      },
      {
         "properties":{
            
         },
         "type":"Microsoft.Network/applicationSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"client_asg",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{
            
         },
         "type":"Microsoft.Network/applicationSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"server_asg",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{
            "securityRules":[
               {
                  "properties":{
                     "protocol":"*",
                     "destinationPortRange":"*",
                     "destinationAddressPrefix":"*",
                     "sourceAddressPrefix":"*",
                     "sourcePortRange":"*",
                     "access":"Deny",
                     "direction":"Inbound",
                     "priority":4080
                  },
                  "name":"denyAllTraffic"
               },
               {
                  "properties":{
                     "protocol":"TCP",
                     "sourcePortRange":"*",
                     "access":"Allow",
                     "direction":"Inbound",
                     "priority":100,
                     "destinationPortRange":"*",
                     "destinationApplicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','server_asg')]"
                        }
                     ],
                     "sourceApplicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]"
                        }
                     ]
                  },
                  "name":"client_can_access_server"
               }
            ]
         },
         "type":"Microsoft.Network/networkSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"server_security_group",
         "apiVersion":"2017-10-01",
         "dependsOn":[
            "client_asg",
            "server_asg"
         ]
      },
      {
         "properties":{
            "securityRules":[
               {
                  "properties":{
                     "description":"denySandboxTraffic",
                     "protocol":"*",
                     "destinationPortRange":"*",
                     "destinationAddressPrefix":"*",
                     "sourceAddressPrefix":"*",
                     "sourcePortRange":"*",
                     "access":"Deny",
                     "direction":"Inbound",
                     "priority":4080
                  },
                  "name":"denyAllTraffic"
               },
               {
                  "properties":{
                     "protocol":"Tcp",
                     "sourcePortRange":"*",
                     "access":"Allow",
                     "direction":"Inbound",
                     "priority":130,
                     "destinationPortRanges":[
                        "3000"
                     ],
                     "destinationApplicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]"
                        }
                     ],
                     "sourceAddressPrefix":"[reference(resourceId('Microsoft.Network/virtualNetworks/subnets', 'vnet', 'ag_subnet'), '2017-10-01').addressPrefix]"
                  },
                  "name":"ag_can_access_client"
               }
            ]
         },
         "type":"Microsoft.Network/networkSecurityGroups",
         "location":"[resourceGroup().location]",
         "name":"app_shared_security_group",
         "apiVersion":"2017-10-01",
         "dependsOn":[
            "client_asg",
            "vnet"
         ]
      },
      {
         "properties":{
            "ipConfigurations":[
               {
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[resourceId('Microsoft.Network/virtualNetworks/subnets', 'vnet', 'app_subnet')]"
                     },
                     "applicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','client_asg')]"
                        }
                     ]
                  },
                  "name":"client_nicIPConf"
               }
            ],
            "networkSecurityGroup":{
               "id":"[resourceId('Microsoft.Network/networkSecurityGroups/','app_shared_security_group')]"
            }
         },
         "type":"Microsoft.Network/networkInterfaces",
         "dependsOn":[
            "app_shared_security_group",
            "client_asg",
            "vnet"
         ],
         "location":"[resourceGroup().location]",
         "name":"client_nic",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{
            "ipConfigurations":[
               {
                  "properties":{
                     "privateIPAllocationMethod":"Dynamic",
                     "subnet":{
                        "id":"[resourceId('Microsoft.Network/virtualNetworks/subnets', 'vnet', 'mng_subnet')]"
                     },
                     "applicationSecurityGroups":[
                        {
                           "id":"[resourceId('Microsoft.Network/applicationSecurityGroups/','server_asg')]"
                        }
                     ]
                  },
                  "name":"server_nicIPConf"
               }
            ],
            "networkSecurityGroup":{
               "id":"[resourceId('Microsoft.Network/networkSecurityGroups/','server_security_group')]"
            }
         },
         "type":"Microsoft.Network/networkInterfaces",
         "dependsOn":[
            "server_security_group",
            "server_asg",
            "vnet"
         ],
         "location":"[resourceGroup().location]",
         "name":"server_nic",
         "apiVersion":"2017-10-01"
      },
      {
         "type":"Microsoft.Resources/deployments",
         "apiVersion":"2018-02-01",
         "name":"nsg_flow_logs_template",
         "resourceGroup":"NetworkWatcherRG",
         "dependsOn":[
            "server_security_group"
         ],
         "properties":{
            "template":{
               "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
               "contentVersion":"1.0.0.0",
               "parameters":{
                  "networkSecurityGroupId":{
                     "type":"string"
                  },
                  "storageAccountId":{
                     "type":"string"
                  }
               },
               "resources":[
                  {
                     "name":"[concat('NetworkWatcher_westeurope/FlowLogOfAzureNsgTicket', uniqueString(resourceGroup().id))]",
                     "type":"Microsoft.Network/networkWatchers/flowLogs",
                     "location":"westeurope",
                     "apiVersion":"2019-09-01",
                     "properties":{
                        "targetResourceId":"[parameters('networkSecurityGroupId')]",
                        "storageId":"[parameters('storageAccountId')]",
                        "enabled":true,
                        "flowAnalyticsConfiguration":{
                           
                        },
                        "retentionPolicy":{
                           "days":1,
                           "enabled":true
                        },
                        "format":{
                           "type":"JSON",
                           "version":1
                        }
                     }
                  }
               ]
            },
            "mode":"Incremental",
              "expressionEvaluationOptions": {
                 "scope": "inner"
             },
            "parameters":{
               "networkSecurityGroupId":{
                  "value":"[resourceId('Microsoft.Network/networkSecurityGroups/', 'server_security_group')]"
               },
               "storageAccountId":{
                  "value":"[parameters('storageAccountId')]"
               }
            }
         }
      },
      {
         "properties":{
            "hardwareProfile":{
               "vmSize":"Basic_A1"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"Canonical",
                  "offer":"UbuntuServer",
                  "sku":"16.04-LTS",
                  "version":"latest"
               },
               "osDisk":{
                  "createOption":"FromImage",
                  "managedDisk":{
                     "storageAccountType":"Standard_LRS"
                  }
               },
               "dataDisks":[
                  
               ]
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces/','server_nic')]"
                  }
               ]
            },
            "osProfile":{
               "adminUsername":"adminuser",
               "adminPassword":"_ozu%X0qtn750feS^",
               "computerName":"server",
               "linuxConfiguration":{
                  "disablePasswordAuthentication":false
               }
            }
         },
         "type":"Microsoft.Compute/virtualMachines",
         "location":"[resourceGroup().location]",
         "name":"server",
         "apiVersion":"2019-12-01",
         "dependsOn":[
            "server_nic"
         ]
      },
      {
         "properties":{
            "hardwareProfile":{
               "vmSize":"Basic_A1"
            },
            "storageProfile":{
               "imageReference":{
                  "publisher":"Canonical",
                  "offer":"UbuntuServer",
                  "sku":"16.04-LTS",
                  "version":"latest"
               },
               "osDisk":{
                  "createOption":"FromImage",
                  "managedDisk":{
                     "storageAccountType":"Standard_LRS"
                  }
               },
               "dataDisks":[
                  
               ]
            },
            "networkProfile":{
               "networkInterfaces":[
                  {
                     "id":"[resourceId('Microsoft.Network/networkInterfaces/','client_nic')]"
                  }
               ]
            },
            "osProfile":{
               "adminUsername":"adminuser",
               "adminPassword":"_ozu%X0qtn750feS^",
               "computerName":"client",
               "linuxConfiguration":{
                  "disablePasswordAuthentication":false
               }
            }
         },
         "type":"Microsoft.Compute/virtualMachines",
         "location":"[resourceGroup().location]",
         "name":"client",
         "apiVersion":"2019-12-01",
         "dependsOn":[
            "client_nic"
         ]
      },
      {
         "properties":{
            "publisher":"Microsoft.Azure.Extensions",
            "type":"CustomScript",
            "autoUpgradeMinorVersion":true,
            "typeHandlerVersion":"2.0",
            "protectedSettings":{
               "commandToExecute":"while true; do sleep 5; wget server.azure.ticket.com:2999 && break; done",
               "fileUris":[
                  
               ]
            }
         },
         "type":"Microsoft.Compute/virtualMachines/extensions",
         "dependsOn":[
            "client"
         ],
         "location":"[resourceGroup().location]",
         "name":"client/CustomScriptForLinux",
         "apiVersion":"2017-12-01"
      },
      {
         "properties":{
            "publisher":"Microsoft.Azure.Extensions",
            "type":"CustomScript",
            "autoUpgradeMinorVersion":true,
            "typeHandlerVersion":"2.0",
            "protectedSettings":{
               "commandToExecute":"echo -e 'HTTP/1.1 200 OK\n\n It works!!!!' | nc -l 2999",
               "fileUris":[
                  
               ]
            }
         },
         "type":"Microsoft.Compute/virtualMachines/extensions",
         "dependsOn":[
            "server"
         ],
         "location":"[resourceGroup().location]",
         "name":"server/CustomScriptForLinux",
         "apiVersion":"2017-12-01"
      },
      {
         "properties":{
            "ttl":3600,
            "aRecords":[
               {
                  "ipv4Address":"[reference(resourceId('Microsoft.Network/networkInterfaces/','server_nic'), '2017-10-01').ipConfigurations[0].properties.privateIPAddress]"
               }
            ]
         },
         "type":"Microsoft.Network/privateDnsZones/A",
         "location":"global",
         "dependsOn":[
            "server_nic",
            "azure.ticket.com"
         ],
         "name":"azure.ticket.com/server",
         "apiVersion":"2018-09-01"
      },
      {
         "properties":{
            "ttl":3600,
            "aRecords":[
               {
                  "ipv4Address":"[reference(resourceId('Microsoft.Network/networkInterfaces/','client_nic'), '2017-10-01').ipConfigurations[0].properties.privateIPAddress]"
               }
            ]
         },
         "type":"Microsoft.Network/privateDnsZones/A",
         "location":"global",
         "dependsOn":[
            "client_nic",
            "azure.ticket.com"
         ],
         "name":"azure.ticket.com/client",
         "apiVersion":"2018-09-01"
      },
      {
         "properties":{
            "publicIPAllocationMethod":"Static"
         },
         "type":"Microsoft.Network/publicIPAddresses",
         "sku":{
            "name":"Standard",
            "tier":"Regional"
         },
         "location":"[resourceGroup().location]",
         "name":"ag_pub_ip",
         "apiVersion":"2017-10-01"
      },
      {
         "properties":{
            "sku":{
               "name":"Standard_v2",
               "tier":"Standard_v2"
            },
            "autoscaleConfiguration":{
               "minCapacity":2
            },
            "gatewayIPConfigurations":[
               {
                  "properties":{
                     "subnet":{
                        "id":"[resourceId( 'Microsoft.Network/virtualNetworks/subnets', 'vnet', 'ag_subnet')]"
                     }
                  },
                  "type":"Microsoft.Network/applicationGateways/gatewayIPConfigurations",
                  "name":"ag_back_ip_conf"
               }
            ],
            "frontendIPConfigurations":[
               {
                  "properties":{
                     "publicIPAddress":{
                        "id":"[resourceId('Microsoft.Network/publicIPAddresses/','ag_pub_ip')]"
                     }
                  },
                  "type":"Microsoft.Network/applicationGateways/frontendIPConfigurations",
                  "name":"ag_front_ip_conf"
               }
            ],
            "frontendPorts":[
               {
                  "properties":{
                     "port":3000
                  },
                  "type":"Microsoft.Network/applicationGateways/frontendPorts",
                  "name":"front_port_3000"
               }
            ],
            "backendAddressPools":[
               {
                  "properties":{
                     "backendAddresses":[
                        {
                           "ipAddress":"[reference(resourceId('Microsoft.Network/networkInterfaces/','client_nic'), '2017-10-01').ipConfigurations[0].properties.privateIPAddress]"
                        }
                     ]
                  },
                  "type":"Microsoft.Network/applicationGateways/backendAddressPools",
                  "name":"backend_pool_36fb8a15af"
               },
               {
                  "properties":{
                     "backendAddresses":[
                        
                     ]
                  },
                  "type":"Microsoft.Network/applicationGateways/backendAddressPools",
                  "name":"empty"
               }
            ],
            "backendHttpSettingsCollection":[
               {
                  "properties":{
                     "cookieBasedAffinity":"Disabled",
                     "connectionDraining":{
                        "enabled":true,
                        "drainTimeoutInSec":30
                     },
                     "port":3000,
                     "protocol":"Http",
                     "requestTimeout":30
                  },
                  "type":"Microsoft.Network/applicationGateways/backendHttpSettingsCollection",
                  "name":"http_settings_36fb8a15af"
               },
               {
                  "properties":{
                     "port":999,
                     "protocol":"Http",
                     "requestTimeout":30
                  },
                  "type":"Microsoft.Network/applicationGateways/backendHttpSettingsCollection",
                  "name":"empty"
               }
            ],
            "httpListeners":[
               {
                  "properties":{
                     "frontendPort":{
                        "id":"[resourceId('Microsoft.Network/applicationGateways/frontendPorts', 'ag', 'front_port_3000')]"
                     },
                     "frontendIPConfiguration":{
                        "id":"[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations', 'ag', 'ag_front_ip_conf')]"
                     },
                     "protocol":"HTTP",
                     "hostName":""
                  },
                  "type":"Microsoft.Network/applicationGateways/httpListeners",
                  "name":"http_listener_d3a2deab70"
               }
            ],
            "requestRoutingRules":[
               {
                  "properties":{
                     "ruleType":"PathBasedRouting",
                     "urlPathMap":{
                        "id":"[resourceId('Microsoft.Network/applicationGateways/urlPathMaps', 'ag', 'path_url_map_e3e12be6b2')]"
                     },
                     "httpListener":{
                        "id":"[resourceId('Microsoft.Network/applicationGateways/httpListeners', 'ag', 'http_listener_d3a2deab70')]"
                     }
                  },
                  "type":"Microsoft.Network/applicationGateways/requestRoutingRules",
                  "name":"rule_d3a2deab70"
               }
            ],
            "probes":[
               
            ],
            "sslCertificates":[
               
            ],
            "urlPathMaps":[
               {
                  "properties":{
                     "defaultBackendAddressPool":{
                        "id":"[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', 'ag', 'empty')]"
                     },
                     "defaultBackendHttpSettings":{
                        "id":"[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', 'ag', 'empty')]"
                     },
                     "pathRules":[
                        {
                           "properties":{
                              "backendAddressPool":{
                                 "id":"[resourceId('Microsoft.Network/applicationGateways/backendAddressPools', 'ag', 'backend_pool_36fb8a15af')]"
                              },
                              "backendHttpSettings":{
                                 "id":"[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection', 'ag', 'http_settings_36fb8a15af')]"
                              },
                              "paths":[
                                 "/*"
                              ]
                           },
                           "type":"Microsoft.Network/applicationGateways/urlPathMaps/pathRules",
                           "name":"path_rule_default"
                        }
                     ]
                  },
                  "type":"Microsoft.Network/applicationGateways/urlPathMaps",
                  "name":"path_url_map_e3e12be6b2"
               }
            ],
            "redirectConfigurations":[
               
            ]
         },
         "type":"Microsoft.Network/applicationGateways",
         "dependsOn":[
            "ag_pub_ip",
            "client_nic",
            "vnet"
         ],
         "location":"[resourceGroup().location]",
         "name":"ag",
         "apiVersion":"2018-10-01"
      }
   ]
}